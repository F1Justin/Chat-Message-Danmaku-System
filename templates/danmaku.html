<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群聊弹幕</title>
    <style>
        :root {
            --danmaku-font-size: 32px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Microsoft YaHei', 'Segoe UI', 'Helvetica Neue', Ubuntu, 'Noto Sans', 'Source Han Sans CN', 'Source Han Sans SC', sans-serif;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        .danmaku {
            position: absolute;
            white-space: nowrap;
            font-size: var(--danmaku-font-size);
            font-weight: bold;
            text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000;
            will-change: transform, left;
            user-select: none;
            z-index: 10;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            transform: translateZ(0);
            pointer-events: none;
        }
        
        #debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 14px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 100;
            display: none;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="debug-info">弹幕数: <span id="danmaku-count">0</span></div>
    
    <script>
        // 配置
        const config = {
            maxDanmaku: 100,
            fontSize: 24,
            animationMethod: 'css',
            showDebug: false
        };
        
        // 状态变量
        let socket = null;
        let danmakuContainer = null;
        let debugPanel = null;
        let activeDanmakuCount = 0;
        let processedMessages = new Set(); // 用于存储已处理的消息ID，防止重复
        let filterSettings = {
            enabled: false,
            groupId: null
        };
        
        // 初始化
        window.onload = function() {
            danmakuContainer = document.getElementById('container');
            debugPanel = document.getElementById('debug-info');
            
            // 检查URL参数
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('debug')) {
                config.showDebug = urlParams.get('debug') === 'true';
                toggleDebugPanel();
            }
            
            // 连接WebSocket
            connectWebSocket();
            
            // 监听来自控制面板的消息
            window.addEventListener('message', function(event) {
                try {
                    const data = event.data;
                    
                    if (data.action === 'showRecentMessages') {
                        // 显示最近消息
                        showRecentMessages(data.messages);
                    } else if (data.action === 'newDanmaku') {
                        // 显示新弹幕
                        processDanmaku(data.message);
                    } else if (data.action === 'clearDanmaku') {
                        // 清空弹幕
                        clearAllDanmaku();
                    } else if (data.action === 'updateSettings') {
                        // 更新设置
                        updateSettings(data.settings);
                    } else if (data.action === 'setFilter') {
                        // 设置过滤
                        filterSettings.enabled = data.enabled;
                        filterSettings.groupId = data.groupId;
                        addDebugMessage(`过滤设置已更新: 启用=${filterSettings.enabled}, 群ID=${filterSettings.groupId}`);
                    }
                } catch (error) {
                    addDebugMessage(`处理控制面板消息错误: ${error.message}`);
                }
            });
            
            // 通知控制面板预览框已准备好
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'previewReady' }, '*');
                addDebugMessage("已通知控制面板预览框准备就绪");
            }
        };
        
        // 连接WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            addDebugMessage(`正在连接到 ${wsUrl}`);
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(e) {
                addDebugMessage("WebSocket连接成功");
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addDebugMessage(`收到消息: ${data.type}`);
                    
                    if (data.type === 'danmaku') {
                        // 处理弹幕消息
                        processDanmaku(data);
                    } else if (data.type === 'settings') {
                        // 处理设置更新
                        updateSettings(data.settings);
                    } else if (data.type === 'active_group') {
                        // 处理活跃群组设置
                        addDebugMessage(`收到活跃群组: ${data.group_id}`);
                        filterSettings.enabled = true;
                        filterSettings.groupId = data.group_id;
                        addDebugMessage(`过滤设置已更新: 启用=true, 群ID=${data.group_id}`);
                    } else if (data.type === 'connection') {
                        // 连接消息
                        addDebugMessage(`连接状态: ${data.message}`);
                    }
                } catch (error) {
                    addDebugMessage(`处理WebSocket消息错误: ${error.message}`);
                }
            };
            
            socket.onclose = function(event) {
                if (event.wasClean) {
                    addDebugMessage(`连接已关闭，代码=${event.code} 原因=${event.reason}`);
                } else {
                    addDebugMessage("连接异常断开");
                }
                
                // 尝试重新连接
                setTimeout(connectWebSocket, 3000);
            };
            
            socket.onerror = function(error) {
                addDebugMessage(`WebSocket错误: ${error.message}`);
            };
        }
        
        // 处理弹幕消息
        function processDanmaku(data) {
            // 检查是否已处理过该消息
            if (data.message_id && processedMessages.has(data.message_id)) {
                addDebugMessage(`跳过重复消息: ${data.content.substring(0, 15)}...`);
                return;
            }
            
            // 检查过滤设置
            if (filterSettings.enabled && filterSettings.groupId) {
                // 获取消息的群ID
                const messageGroupId = data.group_id;
                
                // 如果消息不是来自选定的群，则跳过
                if (messageGroupId !== filterSettings.groupId) {
                    addDebugMessage(`过滤消息: 群ID=${messageGroupId}, 不匹配当前过滤群ID=${filterSettings.groupId}`);
                    return;
                }
            }
            
            // 记录消息ID，防止重复处理
            if (data.message_id) {
                processedMessages.add(data.message_id);
            }
            
            // 创建弹幕元素
            createDanmaku(data.content);
            
            // 添加调试信息
            addDebugMessage(`显示弹幕: ${data.content.substring(0, 15)}...`);
        }
        
        // 显示最近消息
        function showRecentMessages(messages) {
            // 清空现有弹幕
            clearAllDanmaku();
            
            // 清空已处理消息记录
            processedMessages.clear();
            
            // 显示最近消息
            let displayedCount = 0;
            messages.forEach(message => {
                // 检查过滤设置
                if (filterSettings.enabled && filterSettings.groupId) {
                    // 如果消息不是来自选定的群，则跳过
                    if (message.group_id !== filterSettings.groupId) {
                        return;
                    }
                }
                
                // 记录消息ID，防止重复处理
                if (message.message_id) {
                    processedMessages.add(message.message_id);
                }
                
                // 创建弹幕元素
                createDanmaku(message.content);
                displayedCount++;
            });
            
            addDebugMessage(`显示了 ${displayedCount} 条最近消息，过滤后共 ${messages.length} 条`);
        }
        
        // 创建弹幕元素
        function createDanmaku(text, userId, messageId) {
            // 检查活跃弹幕数量，如果超过最大数量，直接返回
            if (activeDanmakuCount >= config.maxDanmaku) {
                console.log('已达最大弹幕数量，丢弃新弹幕');
                return;
            }
            
            // 防止XSS
            const safeText = String(text).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            const trackHeight = danmakuContainer.clientHeight - config.fontSize;
            
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku';
            danmaku.innerHTML = safeText;
            danmaku.style.fontSize = `${config.fontSize}px`;
            danmaku.setAttribute('data-message-id', messageId || '');
            
            // 随机颜色
            const colors = [
                '#FFFFFF', // 白色
                '#FF8C00', // 深橙色
                '#FFD700', // 金色
                '#00BFFF', // 深天蓝
                '#7FFF00', // 查特酸绿
                '#FF69B4', // 热粉红
                '#00FFFF', // 青色
                '#F0E68C', // 卡其色
                '#FFA07A', // 浅鲑鱼色
                '#00FA9A'  // 中春绿色
            ];
            
            // 使用用户ID来选择一个固定的颜色（如果有userId）
            let colorIndex = 0;
            if (userId) {
                const userHash = String(userId).split('').reduce((a, b) => {
                    return a + b.charCodeAt(0);
                }, 0);
                colorIndex = userHash % colors.length;
            } else {
                colorIndex = Math.floor(Math.random() * colors.length);
            }
            
            danmaku.style.color = colors[colorIndex];
            
            // 随机垂直位置
            const top = Math.floor(Math.random() * trackHeight);
            danmaku.style.top = `${top}px`;
            
            // 添加到容器
            danmakuContainer.appendChild(danmaku);
            
            // 获取宽度
            const danmakuWidth = danmaku.offsetWidth;
            
            // 设置初始位置（确保在屏幕右侧外）
            const containerWidth = danmakuContainer.clientWidth;
            const startPosition = containerWidth;
            const endPosition = -danmakuWidth;
            
            // 根据文本长度计算动画持续时间：短消息更快，长消息更慢
            // 基础速度：每秒移动屏幕宽度的15%（约6-7秒穿过屏幕）
            const baseDuration = 6000;
            // 文本长度影响系数：每多10个字符增加0.5秒时间
            const lengthFactor = Math.min(3000, Math.max(0, safeText.length * 50));
            const duration = baseDuration + lengthFactor;
            
            console.log(`弹幕: "${safeText.substring(0, 20)}${safeText.length > 20 ? '...' : ''}" 宽度=${danmakuWidth}px, 持续时间=${duration}ms`);
            
            // 增加活跃弹幕计数
            activeDanmakuCount++;
            updateDanmakuCount();
            
            if (config.animationMethod === 'transform') {
                // 确保弹幕起始位置在屏幕外右侧
                danmaku.style.transform = `translateX(${startPosition}px)`;
                
                // 强制浏览器重绘，以确保起始位置已应用
                void danmaku.offsetWidth;
                
                // 设置过渡属性，确保动画流畅
                danmaku.style.transition = `transform ${duration}ms linear`;
                
                // 设置延迟，确保上一步的样式已应用
                requestAnimationFrame(() => {
                    // 开始动画，移动到目标位置
                    danmaku.style.transform = `translateX(${endPosition}px)`;
                    
                    // 动画结束后移除弹幕
                    setTimeout(() => {
                        if (danmaku && danmaku.parentNode) {
                            danmaku.parentNode.removeChild(danmaku);
                            activeDanmakuCount--;
                            updateDanmakuCount();
                        }
                    }, duration + 200); // 增加延迟确保动画完成后再移除
                });
            } else {
                // 使用left属性实现动画(兼容性更好但性能较差)
                danmaku.style.left = `${startPosition}px`;
                
                // 创建动画帧
                let startTime = null;
                
                function animateFrame(timestamp) {
                    if (!startTime) startTime = timestamp;
                    const elapsed = timestamp - startTime;
                    
                    if (elapsed < duration) {
                        const progress = elapsed / duration;
                        const currentPos = startPosition - progress * (startPosition - endPosition);
                        danmaku.style.left = `${currentPos}px`;
                        requestAnimationFrame(animateFrame);
                    } else {
                        // 动画结束，移除弹幕
                        if (danmaku && danmaku.parentNode) {
                            danmaku.parentNode.removeChild(danmaku);
                            activeDanmakuCount--;
                            updateDanmakuCount();
                        }
                    }
                }
                
                // 启动动画
                requestAnimationFrame(animateFrame);
            }
        }
        
        // 更新弹幕计数显示
        function updateDanmakuCount() {
            debugPanel.textContent = activeDanmakuCount;
            
            // 向父窗口报告弹幕数量（用于控制台显示）
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({
                    type: 'danmakuStats',
                    count: activeDanmakuCount
                }, '*');
            }
        }
        
        // 清空所有弹幕
        function clearAllDanmaku() {
            danmakuContainer.innerHTML = '';
            activeDanmakuCount = 0;
            updateDanmakuCount();
        }
        
        // 应用设置
        function updateSettings(settings) {
            if (settings.fontSize && typeof settings.fontSize === 'number') {
                config.fontSize = settings.fontSize;
                document.documentElement.style.setProperty('--danmaku-font-size', `${config.fontSize}px`);
                console.log(`字体大小已更新为 ${config.fontSize}px`);
            }
            
            if (settings.maxDanmaku && typeof settings.maxDanmaku === 'number') {
                config.maxDanmaku = settings.maxDanmaku;
                console.log(`最大弹幕数已更新为 ${config.maxDanmaku}`);
            }
            
            if (settings.animationMethod) {
                config.animationMethod = settings.animationMethod;
                console.log(`动画方式已更新为 ${config.animationMethod}`);
            }
            
            // 更新所有现有弹幕的字体大小
            document.querySelectorAll('.danmaku').forEach(element => {
                element.style.fontSize = `${config.fontSize}px`;
            });
        }
        
        // 显示调试信息
        function toggleDebugPanel() {
            debugPanel.style.display = config.showDebug ? 'block' : 'none';
        }
        
        // 添加调试信息
        function addDebugMessage(message) {
            console.log(message);
            // 这里可以根据需要将调试信息添加到页面上的某个元素中
        }
    </script>
</body>
</html> 